<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Hawkular - External Keycloak</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- css -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/tabzilla.css" rel="stylesheet">
    <link href="../../css/styles.css" rel="stylesheet">
    <link href="../../css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="../../js/moment.min.js"></script>
    <script src="../../js/jquery-1.11.2.min.js"></script>

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../favicon.ico">
    
  </head>
  <body onload="prettyPrint()" data-spy="scroll" data-offset="80" data-target="#toc">
    <div id="wrap">
      <div class="dropup">
        <a class="tabnav-closed" href="#" id="tab">Red Hat</a>
        <script>
            window.addEventListener('load', function() {
                 renderTabzilla("Hawkular", "https://hawkular.github.io", true );
            }, false);
        </script>
      </div>

	<!-- Fixed navbar -->
    <nav class="navbar navbar-fixed-top" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button class="navbar-toggle collapsed" data-target="#bs-example-navbar-collapse-1" data-toggle="collapse" type="button">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../index.html">Home</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="../../index.html">Hawkular</a></li>
            <li>
              <a href="../../docs/user/getting-started.html">Getting
                  Started</a>
            </li>
            <li class=""><a href="../../downloads.html">Downloads</a></li>
            <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
              Documentation
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <a href="../../docs/user/getting-started.html">User Documentation</a>
              </li>
              <li>
                <a href="../../docs/dev/development.html">Developer Documentation</a>
              </li>
              <li>
                <a href="../../docs/dev/terms.html">Used Terms</a>
              </li>
              <li class="menu-item dropdown dropdown-submenu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">REST API</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../docs/rest/rest-alerts.html">Alerts</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../docs/rest/rest-btm.html">Business Transaction Management</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../docs/rest/rest-inventory.html">Inventory</a>
                  </li>
                  <li class="menu-item ">
                    <a href="../../docs/rest/rest-metrics.html">Metrics</a>
                  </li>
                </ul>
              </li>
              <li class="menu-item dropdown dropdown-submenu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Sub-projects</a>
                <ul class="dropdown-menu">
                  <li class="menu-item ">
                    <a href="../../docs/components/metrics/index.html">Metrics</a>
                  </li>
                </ul>
              </li>
            </ul>
            <li class="dropdown"><a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">
              Community
              <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu">
              <li>
                <a href="../../community/index.html">Home</a>
              </li>
              <li>
                <a href="../../community/join.html">Join</a>
              </li>
              <li>
                <a href="../../license.html">License</a>
              </li>
              <li>
                <a href="https://travis-ci.org/hawkular">CI Builds</a>
              </li>
            </ul></li>
            <li class=""><a href="../../blog.html">Blog</a></li>
          </ul>
        </div>
      </div>
    </nav>

      <section class="main-banner">
        <div class="container">
          <h1>External Keycloak</h1>
          <p>How to use an external Keycloak with Hawkular</p>
        </div>
      </section>

	<!--<p><em>26 June 2015</em></p>-->

	<section>
      <div class="container">
        <div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_preparing_the_environments">Preparing the environments</a>
<ul class="sectlevel2">
<li><a href="#_preparing_keycloak">Preparing Keycloak</a></li>
<li><a href="#_importing_the_realm">Importing the realm</a></li>
<li><a href="#_starting_keycloak">Starting Keycloak</a></li>
<li><a href="#_removing_keycloak_from_hawkular">Removing Keycloak from Hawkular</a></li>
<li><a href="#_starting_hawkular">Starting Hawkular</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hawkular ships with a ready to use instance of Keycloak. In some situations, however, it is desirable to split Hawkular
from Keycloak. This document outlines this process. This document is valid from Hawkular 1.0.0.Alpha3 and later.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparing_the_environments">Preparing the environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For the purposes of this document, both Keycloak and Hawkular will be running on the same machine, but on different
Wildfly instances. Keycloak will be running on a port-offset of 100, while Hawkular will be running on the default
set of Wildfly ports.</p>
</div>
<div class="sect2">
<h3 id="_preparing_keycloak">Preparing Keycloak</h3>
<div class="paragraph">
<p>Before starting Keycloak, we need to copy the event listeners and the themes, deployed as JBoss Modules to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">cd $KEYCLOAK_HOME
mkdir -p modules/org/hawkular/
cp -r $HAWKULAR_HOME/modules/org/hawkular/keycloak modules/org/hawkular/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, change the <code>$KEYCLOAK_HOME/standalone/configuration/keycloak-server.json</code> to add the listeners:</p>
</div>
<div class="paragraph">
<p>Original <code>$KEYCLOAK_HOME/standalone/configuration/keycloak-server.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
    "providers": [
        "classpath:${jboss.server.config.dir}/providers/*"
    ],

    "admin": {
        "realm": "master"
    },

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>New <code>$KEYCLOAK_HOME/standalone/configuration/keycloak-server.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
    "providers": [
        "classpath:${jboss.server.config.dir}/providers/*",
        "module:org.hawkular.keycloak.events.rest",
        "module:org.hawkular.keycloak.events.jms"
    ],

    "eventsListener": {
        "hawkular-rest": {
            "excludes": [ "REFRESH_TOKEN", "CODE_TO_TOKEN", "LOGIN" ]
        },
        "hawkular-jms": {
            "excludes": [ "REFRESH_TOKEN", "CODE_TO_TOKEN", "LOGIN" ]
        }
    },

    "admin": {
        "realm": "master"
    },
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, the Hawkular UI theme should also be activated on this file:</p>
</div>
<div class="paragraph">
<p>Original <code>$KEYCLOAK_HOME/standalone/configuration/keycloak-server.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">    "theme": {
        "default": "keycloak",
        "staticMaxAge": 2592000,
        "cacheTemplates": true,
        "cacheThemes": true,
        "folder": {
          "dir": "${jboss.server.config.dir}/themes"
        }
    },</code></pre>
</div>
</div>
<div class="paragraph">
<p>New <code>$KEYCLOAK_HOME/standalone/configuration/keycloak-server.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">    "theme": {
        "default": "keycloak",
        "staticMaxAge": 2592000,
        "cacheTemplates": true,
        "cacheThemes": true,
        "folder": {
          "dir": "${jboss.server.config.dir}/themes"
        },
        "module": {
            "modules": [ "org.hawkular.keycloak.theme" ]
        }
    },</code></pre>
</div>
</div>
<div class="paragraph">
<p>For our REST listener, we need a system property on the Keycloak server, which we can add to the <code>standalone.xml</code>:</p>
</div>
<div class="paragraph">
<p>Add to <code>$KEYCLOAK_HOME/standalone/configuration/standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;extensions&gt;
...
&lt;/extensions&gt;

&lt;system-properties&gt;
    &lt;property name="hawkular.events.listener.rest.endpoint" value="http://localhost:8080/hawkular-accounts-events-backend/events"/&gt;
&lt;/system-properties&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_importing_the_realm">Importing the realm</h3>
<div class="paragraph">
<p>The Hawkular realm for Keycloak can either be imported via the <code>-Dkeycloak.import=/path/to/hawkular-realm.json</code> or
via the UI once the Keycloak server boots.</p>
</div>
<div class="paragraph">
<p>Before importing, change the event listener from JMS to REST on the
<code>$HAWKULAR_HOME/standalone/configuration/hawkular-realm.json</code> file:</p>
</div>
<div class="paragraph">
<p>Before <code>$HAWKULAR_HOME/standalone/configuration/hawkular-realm.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "id" : "hawkular-realm",
  ...
  "eventsListeners" : [ "hawkular-jms", "jboss-logging" ],
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After <code>$HAWKULAR_HOME/standalone/configuration/hawkular-realm.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "id" : "hawkular-realm",
  ...
  "eventsListeners" : [ "hawkular-rest", "jboss-logging" ],
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And add the Hawkular URL to the allowed redirect URIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json"> "applications" : [
    {
      "name": "hawkular-accounts-backend",
      "redirectUris": ["/*", "http://localhost:8080/*"],
      "webOrigins": ["http://localhost:8080"],
      ...
    },
    {
      "name": "hawkular-ui",
      "redirectUris": ["/*", "http://localhost:8080/*"],
      "webOrigins": ["http://localhost:8080"],
      ...
    }
  ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the system property <code>keycloak.import</code> to load the Hawkular realm, make sure that it gets properly imported
by checking this log entry from Wildfly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">11:19:50,670 INFO  [org.keycloak.services.resources.KeycloakApplication] (ServerService Thread Pool -- 62) Imported
realm hawkular from file /path/to/hawkular-realm.json</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_starting_keycloak">Starting Keycloak</h3>
<div class="paragraph">
<p>For our purposes, we&#8217;ll start Keycloak with a port offset of 100, meaning that the Keycloak UI console will be
available on the port 8180, as we want Hawkular to run on port 8080.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$KEYCLOAK_HOME/bin/standalone.sh -Djboss.socket.binding.port-offset=100
-Dkeycloak.import=$HAWKULAR_HOME/standalone/configuration/hawkular-realm.json</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_removing_keycloak_from_hawkular">Removing Keycloak from Hawkular</h3>
<div class="paragraph">
<p>To remove the Keycloak server from Hawkular, remove the server extension and subsystem from the <code>standalone.xml</code>:</p>
</div>
<div class="paragraph">
<p>Remove from <code>$HAWKULAR_HOME/standalone/configuration/standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;extension module="org.keycloak.keycloak-server-subsystem"/&gt;</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Make sure to remove the <strong>server</strong> subsystem, and not the <strong>adapter</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Remove from <code>$HAWKULAR_HOME/standalone/configuration/standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;subsystem xmlns="urn:jboss:domain:keycloak-server:1.1"&gt;
    &lt;web-context&gt;auth&lt;/web-context&gt;
&lt;/subsystem&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, you might want to remove the <code>KeycloakDS</code> data source, the <code>keycloak.import</code> and the
<code>hawkular.events.listener.rest.endpoint</code> system properties:</p>
</div>
<div class="paragraph">
<p>Remove from <code>$HAWKULAR_HOME/standalone/configuration/standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;datasource jndi-name="java:jboss/datasources/KeycloakDS" pool-name="KeycloakDS" enabled="true" use-java-context="true"&gt;
    &lt;connection-url&gt;jdbc:h2:${jboss.server.data.dir}${/}h2${/}keycloak;AUTO_SERVER=TRUE&lt;/connection-url&gt;
    &lt;driver&gt;h2&lt;/driver&gt;
    &lt;security&gt;
        &lt;user-name&gt;sa&lt;/user-name&gt;
        &lt;password&gt;sa&lt;/password&gt;
    &lt;/security&gt;
&lt;/datasource&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remove from <code>$HAWKULAR_HOME/standalone/configuration/standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;property name="keycloak.import" value="${jboss.home.dir}/standalone/configuration/hawkular-realm-for-dev.json"/&gt;
&lt;property name="hawkular.events.listener.rest.endpoint" value="http://localhost:8080/hawkular-accounts-events-backend/events"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, tell the Keycloak Wildfly Adapter what is the URL for the Keycloak Server:</p>
</div>
<div class="paragraph">
<p><code>$HAWKULAR_HOME/standalone/configuration/standalone.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;realm name="hawkular"&gt;
    &lt;auth-server-url&gt;http://localhost:8180/auth&lt;/auth-server-url&gt;
    &lt;auth-server-url-for-backend-requests&gt;http://localhost:8180/auth&lt;/auth-server-url-for-backend-requests&gt;
    &lt;ssl-required&gt;none&lt;/ssl-required&gt;
&lt;/realm&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the same thing for the Keycloak JavaScript Adapter.
<code>$HAWKULAR_HOME/modules/org/hawkular/nest/main/deployments/hawkular-console.war/keycloak.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "realm": "hawkular",
  "auth-server-url": "http://localhost:8180/auth",
  "ssl-required": "none",
  "resource": "hawkular-ui",
  "public-client": true
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally, remove the JBoss modules for the listeners and Keycloak UI theme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">rm -rf $HAWKULAR_HOME/modules/org/hawkular/keycloak</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_starting_hawkular">Starting Hawkular</h3>
<div class="paragraph">
<p>Once Keycloak has been fully removed from Hawkular, it can be started normally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$HAWKULAR_HOME/bin/standalone.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once it finishes booting, it&#8217;s accessible via <a href="http://localhost:8080" class="bare">http://localhost:8080</a> . After opening this URL, the browser is
redirected to Keycloak for logging in. To confirm that the external Keycloak is being used, check that the URL starts
with <a href="http://localhost:8180/auth" class="bare">http://localhost:8180/auth</a> .</p>
</div>
</div>
</div>
</div>
      </div>
    </section>

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
          <a href="http://www.ej-technologies.com/products/jprofiler/overview.html">Built using JProfiler Java profiler
              <br/>
            <img src="http://www.ej-technologies.com/images/product_banners/jprofiler_small.png" alt="JProfiler logo"/>
           </a>
      </div>
    </div>

    <section class="redhat">
      <div class="container">
        <p class="text-center">
          <a href="http://www.redhat.com/">
            <img alt="redhatlogo-white" src="../..//img/redhatlogo-white.png" width="130">
          </a>
        </p>
        <p class="muted credit">&copy; 2015 | Baked with <a href="http://jbake.org">JBake v2.4.0</a></p>
    <p id="forkongithubp"><span id="forkongithub">
      <a href="https://github.com/hawkular" class="bg-grey">
        Fork me on GitHub
      </a>
    </span></p>
      </div>
    </section>

    <!-- javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- js -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="../../js/jbossorg-tabzilla.js"></script>
    <script src="../../js/behavior.js"></script>
    <script src="../../js/prettify.js"></script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'hawkular';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-61728352-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
